{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <title>员工体温统计</title>

    <style type="text/css">
        #temperature {
            text-align: left;
            outline: none;
            width: 200px;
        }

        #remark {
            text-align: left;
            outline: none;
            vertical-align: top;
            outline: none;
            width: 200px;
        }
    </style>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">

    <link href="{% static '/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href={% static '/css/temperature-recorder.css' %}>

</head>
<body style="overflow: scroll">

<div class="container">
    <br>
    <span id="employee-id"></span>&nbsp&nbsp&nbsp&nbsp
    <span id="team-name"></span>

    <hr/>

    <div class="panel panel-info">
        <div class="panel-body">
            <h3><span class="badge badge-success" id='measureDate'></span></h3>


            <div id="btnMeasureTimes" class="btn-group" data-toggle="buttons">
                <label class="btn btn-success">
                    <input id="morning" type="radio" name='times' class="toggle" checked="checked" value="1"> 上午
                </label>
                <label class="btn btn-success">
                    <input id="afternoon" type="radio" name='times' class="toggle" value="2"> 下午
                </label>
            </div>
        </div>
    </div>

    <table id="infos" class="table .table-bordered border-collapse: separate" cellpadding="100rem">
        <thead class=" .thead-light">
        <tr>
            <th scope="col">员编</th>
            <th scope="col">体温</th>
            <th scope="col">备注</th>
            <th scope="col">记录人</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

    <button id="submitGroupBtnStatus" type="button" class="btn btn-secondary"></button>

</div>


<!-- 模态框（Modal） -->
<div class="modal fade" id="recordModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title align-middle" id="myModalLabel">温度录入</h4>
            </div>
            <div class="modal-body">
                <label>员编：</label><label id="employeeId"></label>
            </div>
            <div class="modal-body">
                <label>体温：</label><input type="text" id="temperature" maxlength="5" placeholder="请输入体温">
            </div>
            <div class="modal-body">
                <label>备注：</label><textarea id="remark" placeholder="请输入备注" rows="3" maxlength="512"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-secondary">关闭</button>
                <button id="submitEmployeeInfo" type="button" data-dismiss="modal" class="btn btn-success">确定</button>
            </div>
        </div>
    </div>
</div>


<script src="{% static 'bootstrap/js/popper.min.js' %}" type="text/javascript"></script>
<script src="{% static 'bootstrap/js/jquery-3.4.1.min.js' %}" type="text/javascript"></script>
<script src="{% static 'bootstrap/js/bootstrap.min.js' %}" type="text/javascript"></script>

<script type="text/javascript">

    initEmployee = function () {
        var employeeId = sessionStorage["employeeId"];
        var teamName = sessionStorage["teamName"];
        $("#employee-id")[0].innerText = employeeId;
        $("#team-name")[0].innerText = teamName;
    };

    initMeasureDate = function () {
        var date = new Date();
        $('#measureDate')[0].innerText = date.toLocaleDateString();
    };

    measureTimes = '1';//代表上午或者下午测量
    $(document).ready(function () {
        //todo  根据当前时间自动切换上午或者下午,各个地方表单校验，返回结果异常处理

        $('input[type=radio][name=times]').change(function () {
            if (this.value == '1') {
                measureTimes = '1';
                loadTemperatureInfos();
            } else if (this.value == '2') {
                measureTimes = '2';
                loadTemperatureInfos();
            }
        });
    });

    var temperatureRecordedFlag = {};//代表当前用户是否记录过温度；
    var submitStatus = false;//组信息是否已经提交
    var setCommitGroupBtnStatus = function () {
        $('#submitGroupBtnStatus').attr('class', function () {
            return $(this).attr('class').replace(/btn-\S*/g, '');
        });

        if (submitStatus) {
            $('#submitGroupBtnStatus').addClass('btn btn-success');
            $('#submitGroupBtnStatus')[0].innerText = '已提交';
            return false;
        }

        if ($.isEmptyObject(temperatureRecordedFlag)) {
            $('#submitGroupBtnStatus').addClass('btn btn-secondary')
            $('#submitGroupBtnStatus')[0].innerText = '未提交';
            return false;
        }

        for (let i in temperatureRecordedFlag) {
            if (!temperatureRecordedFlag[i]) {
                $('#submitGroupBtnStatus').addClass('btn-secondary')
                $('#submitGroupBtnStatus')[0].innerText = '未提交';
                return false;
            }
        }
        $('#submitGroupBtnStatus').addClass('btn-primary')
        $('#submitGroupBtnStatus')[0].innerText = '未提交';
        return true;
    }

    var originalTemperatureInfos = [];//原始温度信息
    $('#recordModal').on('show.bs.modal', function (event) {
        {#var button = $(event.relatedTarget) // Button that triggered the modal#}
        {#var recipient = button.data('whatever') // Extract info from data-* attributes#}
        $('#recordModal #employeeId')[0].innerText = activetedItemInfo.employeeId;
        $('#recordModal #temperature')[0].value = temperatureRecordedFlag[activetedItemInfo.employeeId] ? activetedItemInfo.temperature : '';
        $('#recordModal #remark')[0].value = temperatureRecordedFlag[activetedItemInfo.employeeId] ? activetedItemInfo.remark : '';
    })

    $('#recordModal').on('hidden.bs.modal', function (event) {
        $('#recordModal #employeeId')[0].innerText = '';
        $('#recordModal #temperature')[0].value = '';
        $('#recordModal #remark')[0].value = '';

        loadTemperatureInfos();
    })

    loadTemperatureInfos = function () {
        {#var employeeInfo = {{ employeeInfo|safe }};#}
        $.ajax({
            url: '/TemperatureReporter/queryTeamTemperatureRecords',
            type: 'post',
            dataType: 'json',
            data: {
                {#'sessionId': '??',#}
                'date': $('#measureDate').val(),
                'measureTimes': measureTimes,
                'teamId': sessionStorage["teamId"],
                'recorderId': sessionStorage["employeeId"]
            },
            success: function (data) {
                if (data.respCode == '1000') {
                    //方法中传入的参数data为后台获取的数

                    $("#infos tbody").empty();//重置列表

                    originalTemperatureInfos = data.recordList;
                    submitStatus = data.submitStatus;
                    for (let i in originalTemperatureInfos) {
                        var recordItem = originalTemperatureInfos[i];

                        if ((!recordItem.temperature || recordItem.temperature === '') &&
                            (!recordItem.remark || recordItem.remark === '')) {
                            temperatureRecordedFlag[recordItem.employeeId] = false;
                        } else {
                            temperatureRecordedFlag[recordItem.employeeId] = true;
                        }

                        var tr;
                        tr = '<td>' + recordItem.employeeId + '</td>' +
                            '<td>' + (temperatureRecordedFlag[recordItem.employeeId] ? recordItem.temperature : '尚未记录') + '</td>' +
                            '<td>' + (temperatureRecordedFlag[recordItem.employeeId] ? recordItem.remark : '尚未记录') + '</td>' +
                            '<td>' + (temperatureRecordedFlag[recordItem.employeeId] ? recordItem.recorderId : '尚未记录') + '</td>'
                        $("#infos tbody").append('<tr>' + tr + '</tr>')

                    }

                    $('#infos tr').each(function () {
                        var temperature = $(this).find("td:nth-child(2)").text();
                        if (temperature.indexOf("尚未记录") > -1) {
                            $(this).addClass('table-success');
                        }
                    });

                    {#$('#infos tr:contains("Name")').addClass('my-class');#}

                    setCommitGroupBtnStatus();
                } else {
                    alert(data.respMsg);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                if (textStatus === 'timeout') {
                    alert('请求超時');
                    setTimeout(function () {
                        alert('重新请求');
                    }, 2000);
                }
                //alert(errorThrown);
            }
        })
    };

    var activetedItemInfo = {};//当前被选中的用户温度信息
    $('#infos tbody').on('click', 'tr', function (e) {

        var rowNum = $(this).index()
        activetedItemInfo = originalTemperatureInfos[rowNum];
        $('#recordModal').modal('show')
    });

    $('#recordModal #submitEmployeeInfo').on('click', function () {
        var data = {
            {#"sessionId": "??",#}
            "employeeId": $('#recordModal #employeeId')[0].innerText,
            'teamId': sessionStorage["teamId"],
            {#"employeeName": "",#}
            "temperature": $('#recordModal #temperature')[0].value,
            "measureTimes": measureTimes,
            "recorderId": sessionStorage["employeeId"],
            "remark": $('#recordModal #remark')[0].value
        };
        $.ajax({
            url: '/TemperatureReporter/employeeTemperatureSubmit',
            type: 'post',
            dataType: 'json',
            data: data,
            success: function (result) {
                if (result.respCode == '1000') {
                    alert(result.respMsg);//todo toast
                } else {
                    alert(result.respMsg);//todo toast
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                if (textStatus === 'timeout') {
                    alert('请求超時');
                    setTimeout(function () {
                        alert('重新请求');
                    }, 2000);
                } else {
                    alert('系统异常');
                }
                //alert(errorThrown);
            }
        })
    });

    $('#submitGroupBtnStatus').on('click', function () {
        var data = {
            {#"sessionId": "??",#}
            'teamId': sessionStorage["teamId"],
            'teamName': sessionStorage["teamName"],
            'recorderId': sessionStorage["employeeId"],
            "measureTimes": measureTimes
        };
        $.ajax({
            url: '/TemperatureReporter/teamTemperatureSubmit',
            type: 'post',
            dataType: 'json',
            data: data,
            success: function (result) {
                if (result.respCode == '1000') {
                    alert(result.respMsg);
                } else {
                    alert(result.respMsg);
                }
                loadTemperatureInfos();
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                if (textStatus === 'timeout') {
                    alert('请求超時');
                    setTimeout(function () {
                        alert('重新请求');
                    }, 2000);
                } else {
                    alert('系统异常');
                }
                //alert(errorThrown);
            }
        })
    })

    var initData = function () {
        initMeasureDate();
        loadTemperatureInfos();
        initEmployee();
    };


    $(document).ready(function () {
        initData();
    });


</script>

</body>
</html>